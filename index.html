<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Placement - Cours d'Anglais</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .quiz-content {
            padding: 40px;
        }
        
        .welcome-screen {
            text-align: center;
        }
        
        .welcome-screen h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .welcome-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .question-container {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .question-container.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }
        
        .question h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .level-indicator {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .options {
            display: grid;
            gap: 15px;
        }
        
        .option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .option input[type="radio"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .results {
            display: none;
            text-align: center;
            animation: fadeIn 0.5s ease-in;
        }
        
        .results.show {
            display: block;
        }
        
        .level-result {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .level-result h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .level-description {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .level-description h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        
        .question-counter {
            color: #666;
            font-weight: bold;
        }
        
        .contact-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .contact-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .quiz-content {
                padding: 30px 20px;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Quiz de Placement</h1>
            <p>√âvaluez votre niveau d'anglais en quelques minutes</p>
        </div>
        
        <div class="quiz-content">
            <!-- √âcran d'accueil -->
            <div id="welcome" class="welcome-screen">
                <h2>Bienvenue !</h2>
                <p>Ce quiz vous permettra de d√©terminer votre niveau d'anglais selon le Cadre Europ√©en Commun de R√©f√©rence (CECR). Il ne vous prendra que 10-15 minutes.</p>
                
                <div class="form-group">
                    <label for="firstName">Pr√©nom *</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Nom *</label>
                    <input type="text" id="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">T√©l√©phone</label>
                    <input type="tel" id="phone">
                </div>
                
                <button class="btn" onclick="startQuiz()">Commencer le Quiz</button>
                
                <!-- Bouton admin discret sur la page d'accueil -->
                <button onclick="toggleAdminPanel()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; margin-top: 15px; cursor: pointer; opacity: 0.7;">‚öôÔ∏è Admin</button>
            </div>
            
            <!-- Barre de progression -->
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <!-- Questions du quiz -->
            <div id="quizContainer" style="display: none;">
                <!-- Les questions seront g√©n√©r√©es dynamiquement -->
            </div>
            
            <!-- Navigation -->
            <div id="navigation" style="display: none;" class="navigation">
                <button class="btn" id="prevBtn" onclick="previousQuestion()">‚Üê Pr√©c√©dent</button>
                <span class="question-counter" id="questionCounter"></span>
                <button class="btn" id="nextBtn" onclick="nextQuestion()">Suivant ‚Üí</button>
            </div>
            
            <!-- R√©sultats -->
            <div id="results" class="results">
                <div class="level-result" id="levelResult">
                    <h2 id="finalLevel"></h2>
                    <p id="levelTitle"></p>
                </div>
                
                <div class="level-description" id="levelDescription"></div>
                
                <div class="contact-info">
                    <h4>üéØ Prochaine √©tape</h4>
                    <p>Nos conseillers p√©dagogiques vont vous contacter sous 24h pour vous proposer un parcours personnalis√© adapt√© √† votre niveau.</p>
                </div>
            </div>
            
            <!-- Panneau admin accessible depuis n'importe o√π -->
            <div id="adminPanel" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #ddd;">
                <h4>üë®‚Äçüíº Panneau Administrateur</h4>
                <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #28a745;">
                    <strong>üìä R√©sultats stock√©s :</strong> <span id="resultsCount">0</span> participant(s)
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="testEmailConnection()" style="background: #28a745; margin: 5px; font-size: 16px; padding: 12px 20px;">
                        üîó Tester Email
                    </button>
                    <button class="btn" onclick="sendExcelByEmail()" style="background: #17a2b8; margin: 5px;">üìß Envoyer Excel</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="exportAllToExcel()" style="background: #007bff; margin: 5px;">üíæ T√©l√©charger Excel</button>
                    <button class="btn" onclick="exportResults()" style="background: #6c757d; margin: 5px;">üìÑ T√©l√©charger CSV</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="console.table(getAllResults())" style="background: #ffc107; color: #000; margin: 5px;">üëÅÔ∏è Voir R√©sultats</button>
                    <button class="btn" onclick="clearAllResults()" style="background: #dc3545; margin: 5px;">üóëÔ∏è Effacer Tout</button>
                    <button class="btn" onclick="restartQuiz()" style="background: #6f42c1; margin: 5px;">üîÑ Nouveau Quiz</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="hideAdminPanel()" style="background: #6c757d; margin: 5px;">üëÅÔ∏è‚Äçüó®Ô∏è Masquer Panneau</button>
                </div>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    <strong>Status Email :</strong> 
                    <span id="emailStatus" style="color: #dc3545;">‚ùå Non configur√©</span>
                </p>
                <p style="font-size: 0.9em; color: #666; margin: 5px 0;">
                    <strong>Email de r√©ception :</strong> <code id="adminEmailDisplay">Non configur√©</code>
                </p>
                <p style="font-size: 0.9em; color: #666; margin: 5px 0;">
                    <strong>Raccourcis :</strong> Ctrl+Shift+S (Envoyer Excel), Ctrl+Shift+E (Export), Ctrl+Shift+T (Test)
                </p>
            </div>
        </div>
    </div>

    <!-- SheetJS pour la g√©n√©ration Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- EmailJS pour l'envoi d'emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        // Configuration EmailJS pour envoi Excel
        const EMAILJS_PUBLIC_KEY = 'VOTRE_EMAILJS_PUBLIC_KEY'; // √Ä configurer
        const EMAILJS_SERVICE_ID = 'VOTRE_SERVICE_ID'; // √Ä configurer
        const EMAILJS_TEMPLATE_ID = 'VOTRE_TEMPLATE_ID'; // √Ä configurer
        const ADMIN_EMAIL = 'votre-email@exemple.com'; // Votre email
        
        // Initialiser EmailJS
        if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'VOTRE_EMAILJS_PUBLIC_KEY') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }
        
        // Questions du quiz organis√©es par niveau CECR
        const questions = [
            // A0-A1 (D√©butant absolu/√âl√©mentaire)
            {
                level: "A0-A1",
                question: "Comment dit-on 'Bonjour' en anglais ?",
                options: ["Good morning", "Good night", "Good afternoon", "Goodbye"],
                correct: 0,
                points: 1
            },
            {
                level: "A0-A1", 
                question: "Compl√©tez : 'My name __ John'",
                options: ["am", "is", "are", "be"],
                correct: 1,
                points: 1
            },
            {
                level: "A1",
                question: "Quelle est la bonne question pour demander l'√¢ge ?",
                options: ["How old you are?", "What is your age?", "How old are you?", "How many years do you have?"],
                correct: 2,
                points: 2
            },
            {
                level: "A1",
                question: "Choisissez la phrase correcte :",
                options: ["I have 25 years old", "I am 25 years old", "I have 25 years", "I am 25 years"],
                correct: 1,
                points: 2
            },
            
            // A2 (Pr√©-interm√©diaire)
            {
                level: "A2",
                question: "What did you do yesterday?",
                options: ["I go to the cinema", "I went to the cinema", "I have gone to the cinema", "I was going to the cinema"],
                correct: 1,
                points: 3
            },
            {
                level: "A2",
                question: "Choose the correct sentence:",
                options: ["There is many people here", "There are much people here", "There are many people here", "There is much people here"],
                correct: 2,
                points: 3
            },
            {
                level: "A2",
                question: "How do you express future plans?",
                options: ["I will go tomorrow", "I am going tomorrow", "I go tomorrow", "I shall go tomorrow"],
                correct: 1,
                points: 3
            },
            
            // B1 (Interm√©diaire)
            {
                level: "B1",
                question: "If I __ you, I would accept the offer.",
                options: ["am", "was", "were", "will be"],
                correct: 2,
                points: 4
            },
            {
                level: "B1",
                question: "She has been working here __ five years.",
                options: ["since", "for", "during", "from"],
                correct: 1,
                points: 4
            },
            {
                level: "B1",
                question: "Choose the most natural response: 'How about getting a coffee?'",
                options: ["Yes, I drink coffee", "That sounds great!", "I like coffee very much", "Coffee is good"],
                correct: 1,
                points: 4
            },
            
            // B2 (Interm√©diaire-avanc√©)
            {
                level: "B2",
                question: "The meeting __ by the time you arrive.",
                options: ["will finish", "will be finishing", "will have finished", "is finishing"],
                correct: 2,
                points: 5
            },
            {
                level: "B2",
                question: "She suggested __ the project deadline.",
                options: ["to postpone", "postponing", "postpone", "postponed"],
                correct: 1,
                points: 5
            },
            {
                level: "B2",
                question: "Despite __ hard, he didn't pass the exam.",
                options: ["study", "studying", "to study", "studied"],
                correct: 1,
                points: 5
            },
            
            // C1 (Avanc√©)
            {
                level: "C1",
                question: "The company's profits have been __ declining over the past quarter.",
                options: ["considerably", "considerably much", "considerable", "much considerable"],
                correct: 0,
                points: 6
            },
            {
                level: "C1",
                question: "__ the weather, the event was a great success.",
                options: ["Despite of", "In spite", "Notwithstanding", "Although"],
                correct: 2,
                points: 6
            },
            {
                level: "C1",
                question: "The proposal __ careful consideration before implementation.",
                options: ["requires", "is requiring", "has required", "will be requiring"],
                correct: 0,
                points: 6
            },
            
            // C2 (Ma√Ætrise)
            {
                level: "C2",
                question: "The subtle __ in her argument made it particularly compelling.",
                options: ["nuances", "differences", "changes", "variations"],
                correct: 0,
                points: 7
            },
            {
                level: "C2",
                question: "Had she __ the implications, she would never have agreed.",
                options: ["understand", "understood", "understanding", "to understand"],
                correct: 1,
                points: 7
            }
        ];
        
        let currentQuestion = 0;
        let userAnswers = [];
        let totalScore = 0;
        let quizStarted = false;
        let userData = {};
        
        // Descriptions des niveaux CECR
        const levelDescriptions = {
            "A0": {
                title: "D√©butant absolu",
                description: "Vous commencez √† apprendre vos premiers mots en anglais. Vous pouvez comprendre et utiliser des expressions famili√®res et quotidiennes ainsi que des √©nonc√©s tr√®s simples.",
                example: "Coffee? (Caf√© ?)"
            },
            "A1": {
                title: "√âl√©mentaire", 
                description: "Vous pouvez comprendre et utiliser des expressions famili√®res et quotidiennes ainsi que des √©nonc√©s tr√®s simples qui visent √† satisfaire des besoins concrets.",
                example: "Want coffee with me? (Tu veux un caf√© avec moi ?)"
            },
            "A2": {
                title: "Pr√©-interm√©diaire",
                description: "Vous pouvez communiquer lors de t√¢ches simples et habituelles ne demandant qu'un √©change d'informations simple et direct sur des sujets familiers.",
                example: "Do you want to have coffee together? (Veux-tu prendre un caf√© ensemble ?)"
            },
            "B1": {
                title: "Interm√©diaire",
                description: "Vous pouvez comprendre les points essentiels quand un langage clair et standard est utilis√© et s'il s'agit de sujets familiers concernant le travail, l'√©cole, les loisirs, etc.",
                example: "How about getting a coffee? (Que dirais-tu d'aller prendre un caf√© ?)"
            },
            "B2": {
                title: "Interm√©diaire-avanc√©",
                description: "Vous pouvez comprendre le contenu essentiel de sujets concrets ou abstraits dans un texte complexe, y compris une discussion technique dans votre sp√©cialit√©.",
                example: "Let's get a coffee, shall we? (Allons prendre un caf√©, d'accord ?)"
            },
            "C1": {
                title: "Avanc√©", 
                description: "Vous pouvez comprendre une grande gamme de textes longs et exigeants, ainsi que saisir des significations implicites.",
                example: "Let's grab a coffee! (Allons prendre un caf√© !)"
            },
            "C2": {
                title: "Ma√Ætrise",
                description: "Vous pouvez comprendre sans effort pratiquement tout ce que vous lisez ou entendez et vous exprimer spontan√©ment, tr√®s couramment et de fa√ßon pr√©cise.",
                example: "Coffee? (Usage contextuel parfait)"
            }
        };
        
        function startQuiz() {
            // Valider les champs obligatoires
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!firstName || !lastName || !email) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }
            
            // Valider l'email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Veuillez entrer une adresse email valide.');
                return;
            }
            
            // Sauvegarder les donn√©es utilisateur
            userData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: document.getElementById('phone').value.trim(),
                startTime: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
            
            // Masquer l'√©cran d'accueil et afficher le quiz
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('navigation').style.display = 'flex';
            
            quizStarted = true;
            showQuestion(0);
        }
        
        function showQuestion(index) {
            currentQuestion = index;
            
            // Mettre √† jour la barre de progression
            const progress = ((index) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Mettre √† jour le compteur
            document.getElementById('questionCounter').textContent = `Question ${index + 1} sur ${questions.length}`;
            
            // G√©n√©rer la question
            const question = questions[index];
            const quizContainer = document.getElementById('quizContainer');
            
            quizContainer.innerHTML = `
                <div class="question-container active">
                    <div class="question">
                        <div class="level-indicator">Niveau ${question.level}</div>
                        <h3>${question.question}</h3>
                        <div class="options">
                            ${question.options.map((option, i) => `
                                <div class="option" onclick="selectOption(${i})">
                                    <input type="radio" name="q${index}" value="${i}" id="q${index}_${i}">
                                    <label for="q${index}_${i}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Restaurer la r√©ponse pr√©c√©dente si elle existe
            if (userAnswers[index] !== undefined) {
                selectOption(userAnswers[index]);
            }
            
            // Mettre √† jour les boutons de navigation
            document.getElementById('prevBtn').style.display = index > 0 ? 'inline-block' : 'none';
            document.getElementById('nextBtn').textContent = index === questions.length - 1 ? 'Terminer' : 'Suivant ‚Üí';
        }
        
        function selectOption(optionIndex) {
            // D√©selectionner toutes les options
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));
            
            // S√©lectionner l'option cliqu√©e
            options[optionIndex].classList.add('selected');
            const radio = options[optionIndex].querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Sauvegarder la r√©ponse
            userAnswers[currentQuestion] = optionIndex;
        }
        
        function nextQuestion() {
            if (userAnswers[currentQuestion] === undefined) {
                alert('Veuillez s√©lectionner une r√©ponse avant de continuer.');
                return;
            }
            
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            } else {
                finishQuiz();
            }
        }
        
        function previousQuestion() {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }
        
        function finishQuiz() {
            // Calculer le score
            totalScore = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correct) {
                    totalScore += questions[i].points;
                }
            }
            
            // D√©terminer le niveau
            const level = determineLevel(totalScore);
            
            // Calculer la dur√©e
            const duration = Math.round((new Date().getTime() - new Date(userData.startTime).getTime()) / 60000);
            
            // Pr√©parer les d√©tails des r√©ponses pour Google Sheets
            const detailedAnswers = questions.map((q, i) => {
                const userAnswer = userAnswers[i];
                const isCorrect = userAnswer === q.correct;
                return {
                    question: q.question,
                    level: q.level,
                    userAnswer: q.options[userAnswer] || 'Non r√©pondu',
                    correctAnswer: q.options[q.correct],
                    isCorrect: isCorrect,
                    pointsEarned: isCorrect ? q.points : 0
                };
            });
            
            // Sauvegarder les r√©sultats
            const results = {
                ...userData,
                answers: userAnswers,
                detailedAnswers: detailedAnswers,
                score: totalScore,
                maxScore: questions.reduce((sum, q) => sum + q.points, 0),
                percentage: Math.round((totalScore / questions.reduce((sum, q) => sum + q.points, 0)) * 100),
                level: level,
                completionTime: new Date().toISOString(),
                questionsAnswered: questions.length,
                duration: duration
            };
            
            // Sauvegarder dans localStorage (backup local)
            saveResults(results);
            
            // Envoyer automatiquement par email √† l'administrateur
            sendResultsByEmail(results);
            
            // Afficher les r√©sultats
            showResults(level);
        }
        
        function sendResultsByEmail(results) {
            // V√©rifier la configuration EmailJS
            if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'VOTRE_EMAILJS_PUBLIC_KEY') {
                console.log('EmailJS non configur√©. Donn√©es sauvegard√©es localement seulement.');
                showNotification('üìä R√©sultats sauvegard√©s localement. Configuration email requise pour envoi automatique.', 'warning');
                return;
            }
            
            // Pr√©parer un r√©sum√© des r√©ponses pour l'email
            const answersText = results.detailedAnswers.map((answer, i) => 
                `Question ${i+1} (${answer.level}): ${answer.question}\n` +
                `R√©ponse donn√©e: ${answer.userAnswer}\n` +
                `R√©ponse correcte: ${answer.correctAnswer}\n` +
                `R√©sultat: ${answer.isCorrect ? 'Correct ‚úì' : 'Incorrect ‚úó'}\n` +
                `Points obtenus: ${answer.pointsEarned}/${questions[i].points}\n`
            ).join('\n' + '='.repeat(50) + '\n');
            
            // Pr√©parer l'email individuel pour ce participant
            const emailParams = {
                to_email: ADMIN_EMAIL,
                subject: `üéì Nouveau r√©sultat quiz: ${results.firstName} ${results.lastName} - Niveau ${results.level}`,
                participant_name: `${results.firstName} ${results.lastName}`,
                participant_email: results.email,
                participant_phone: results.phone || 'Non renseign√©',
                participant_level: results.level,
                participant_score: `${results.score}/${results.maxScore} points`,
                participant_percentage: `${results.percentage}%`,
                participant_duration: `${results.duration} minutes`,
                test_date: new Date().toLocaleDateString('fr-FR'),
                test_time: new Date().toLocaleTimeString('fr-FR'),
                detailed_answers: answersText,
                message: `
Nouveau participant au quiz de placement d'anglais :

üë§ INFORMATIONS PARTICIPANT
Nom complet : ${results.firstName} ${results.lastName}
Email : ${results.email}
T√©l√©phone : ${results.phone || 'Non renseign√©'}

üìä R√âSULTATS
Niveau CECR : ${results.level}
Score : ${results.score}/${results.maxScore} points (${results.percentage}%)
Dur√©e du test : ${results.duration} minutes
Date/Heure : ${new Date().toLocaleString('fr-FR')}

üìù D√âTAILS DES R√âPONSES
${answersText}

Cette √©valuation a √©t√© r√©alis√©e via le quiz en ligne automatique.
                `
            };
            
            // Envoyer l'email automatiquement
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailParams)
                .then(function(response) {
                    console.log('Email envoy√© automatiquement !', response);
                    showNotification('‚úÖ R√©sultats envoy√©s par email automatiquement !', 'success');
                }, function(error) {
                    console.error('Erreur envoi email automatique:', error);
                    showNotification('‚ö†Ô∏è Erreur envoi email. R√©sultats sauvegard√©s localement.', 'warning');
                });
        }
        
        function sendExcelByEmail() {
            const results = getAllResults();
            if (results.length === 0) {
                alert('‚ùå Aucun r√©sultat √† envoyer.');
                return;
            }
            
            // V√©rifier la configuration EmailJS
            if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'VOTRE_EMAILJS_PUBLIC_KEY') {
                alert('‚ùå EmailJS non configur√© !');
                return;
            }
            
            showNotification('üìä G√©n√©ration de l\'Excel en cours...', 'warning');
            
            // G√©n√©rer l'Excel
            const excelBlob = generateExcelBlob(results);
            
            // Convertir le blob en base64
            const reader = new FileReader();
            reader.onload = function() {
                const base64Data = reader.result.split(',')[1]; // Enlever le pr√©fixe data:...
                
                // Pr√©parer l'email avec l'Excel en pi√®ce jointe
                const emailParams = {
                    to_email: ADMIN_EMAIL,
                    subject: `üìä Export Excel Quiz Anglais - ${results.length} participants - ${new Date().toLocaleDateString('fr-FR')}`,
                    message: `
Voici l'export Excel consolid√© avec tous les r√©sultats du quiz de placement d'anglais.

üìä R√âSUM√â DE L'EXPORT :
- Nombre total de participants : ${results.length}
- P√©riode couverte : du ${new Date(results[0].completionTime).toLocaleDateString('fr-FR')} au ${new Date(results[results.length-1].completionTime).toLocaleDateString('fr-FR')}
- Date de g√©n√©ration : ${new Date().toLocaleString('fr-FR')}

üìà R√âPARTITION PAR NIVEAU :
${generateLevelSummary(results)}

Le fichier Excel contient 3 feuilles :
1. R√©sum√© de tous les participants
2. Statistiques par niveau  
3. D√©tails des r√©ponses (10 derniers)

Cordialement,
Syst√®me automatique Quiz Anglais
                    `,
                    attachment_name: `Quiz_Anglais_Export_${new Date().toISOString().slice(0,10)}_${results.length}participants.xlsx`,
                    attachment_data: base64Data
                };
                
                // Envoyer l'email
                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailParams)
                    .then(function(response) {
                        console.log('Excel envoy√© par email !', response);
                        showNotification('‚úÖ Excel envoy√© par email avec succ√®s !', 'success');
                        
                        // Optionnel : Vider les r√©sultats apr√®s envoi
                        if (confirm('üìß Excel envoy√© ! Voulez-vous effacer les r√©sultats locaux de ce navigateur admin ?')) {
                            clearAllResults();
                        }
                    }, function(error) {
                        console.error('Erreur envoi email:', error);
                        showNotification('‚ùå Erreur lors de l\'envoi email.', 'warning');
                        alert('Erreur : ' + JSON.stringify(error));
                    });
            };
            
            reader.readAsDataURL(excelBlob);
        }
        
        function generateExcelBlob(results) {
            // Cr√©er un classeur Excel
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: R√©sum√© des participants
            const summaryData = [
                ['Date', 'Heure', 'Pr√©nom', 'Nom', 'Email', 'T√©l√©phone', 'Niveau CECR', 'Score', 'Points Max', 'Pourcentage', 'Dur√©e (min)'],
                ...results.map(result => [
                    new Date(result.completionTime).toLocaleDateString('fr-FR'),
                    new Date(result.completionTime).toLocaleTimeString('fr-FR'),
                    result.firstName,
                    result.lastName,
                    result.email,
                    result.phone || '',
                    result.level,
                    result.score,
                    result.maxScore || questions.reduce((sum, q) => sum + q.points, 0),
                    result.percentage || Math.round((result.score / questions.reduce((sum, q) => sum + q.points, 0)) * 100) + '%',
                    result.duration || 'N/A'
                ])
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Ajuster la largeur des colonnes
            ws1['!cols'] = [
                {wch: 12}, {wch: 10}, {wch: 15}, {wch: 15}, {wch: 25}, 
                {wch: 15}, {wch: 10}, {wch: 8}, {wch: 10}, {wch: 12}, {wch: 10}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws1, "R√©sum√© Participants");
            
            // Feuille 2: Statistiques par niveau
            const levelStats = {};
            results.forEach(result => {
                if (!levelStats[result.level]) {
                    levelStats[result.level] = { count: 0, totalScore: 0, emails: [] };
                }
                levelStats[result.level].count++;
                levelStats[result.level].totalScore += result.score;
                levelStats[result.level].emails.push(result.email);
            });
            
            const statsData = [
                ['Niveau CECR', 'Nombre de Participants', 'Score Moyen', 'Pourcentage du Total'],
                ...Object.entries(levelStats).map(([level, stats]) => [
                    level,
                    stats.count,
                    Math.round(stats.totalScore / stats.count),
                    Math.round((stats.count / results.length) * 100) + '%'
                ])
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws2, "Statistiques");
            
            // Feuille 3: D√©tails des r√©ponses (optionnel, pour les 10 derniers)
            if (results.length > 0) {
                const lastResults = results.slice(-10); // 10 derniers
                const detailsData = [
                    ['Participant', 'Question', 'Niveau Q.', 'R√©ponse Donn√©e', 'R√©ponse Correcte', 'R√©sultat', 'Points']
                ];
                
                lastResults.forEach(result => {
                    if (result.detailedAnswers) {
                        result.detailedAnswers.forEach((answer, i) => {
                            detailsData.push([
                                `${result.firstName} ${result.lastName}`,
                                answer.question || `Question ${i+1}`,
                                answer.level || questions[i]?.level || '',
                                answer.userAnswer || 'Non r√©pondu',
                                answer.correctAnswer || questions[i]?.options[questions[i]?.correct] || '',
                                answer.isCorrect ? 'Correct' : 'Incorrect',
                                answer.pointsEarned || 0
                            ]);
                        });
                    }
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(detailsData);
                XLSX.utils.book_append_sheet(wb, ws3, "D√©tails R√©ponses");
            }
            
            // Convertir en blob
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            return new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        }
        
        function generateLevelSummary(results) {
            const levelStats = {};
            results.forEach(result => {
                levelStats[result.level] = (levelStats[result.level] || 0) + 1;
            });
            
            return Object.entries(levelStats)
                .map(([level, count]) => `- ${level}: ${count} participant${count > 1 ? 's' : ''}`)
                .join('\n');
        }
        
        function generateExcelReport() {
            const results = getAllResults();
            if (results.length === 0) return;
            
            // Cr√©er un classeur Excel
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: R√©sum√© des participants
            const summaryData = [
                ['Date', 'Pr√©nom', 'Nom', 'Email', 'T√©l√©phone', 'Niveau CECR', 'Score', 'Points Max', 'Pourcentage', 'Dur√©e (min)'],
                ...results.map(result => [
                    new Date(result.completionTime).toLocaleDateString('fr-FR'),
                    result.firstName,
                    result.lastName,
                    result.email,
                    result.phone || '',
                    result.level,
                    result.score,
                    questions.reduce((sum, q) => sum + q.points, 0),
                    Math.round((result.score / questions.reduce((sum, q) => sum + q.points, 0)) * 100) + '%',
                    result.duration || 'N/A'
                ])
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, "R√©sum√© Participants");
            
            // Feuille 2: D√©tails des r√©ponses (dernier participant)
            const lastResult = results[results.length - 1];
            const detailsData = [
                ['Question', 'Niveau', 'R√©ponse Donn√©e', 'R√©ponse Correcte', 'R√©sultat', 'Points'],
                ...questions.map((q, i) => [
                    q.question,
                    q.level,
                    q.options[lastResult.answers[i]] || 'Non r√©pondu',
                    q.options[q.correct],
                    lastResult.answers[i] === q.correct ? 'Correct' : 'Incorrect',
                    lastResult.answers[i] === q.correct ? q.points : 0
                ])
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(detailsData);
            XLSX.utils.book_append_sheet(wb, ws2, "D√©tails Dernier Quiz");
            
            // Feuille 3: Statistiques par niveau
            const levelStats = {};
            results.forEach(result => {
                if (!levelStats[result.level]) {
                    levelStats[result.level] = { count: 0, totalScore: 0 };
                }
                levelStats[result.level].count++;
                levelStats[result.level].totalScore += result.score;
            });
            
            const statsData = [
                ['Niveau CECR', 'Nombre de Participants', 'Score Moyen', 'Pourcentage'],
                ...Object.entries(levelStats).map(([level, stats]) => [
                    level,
                    stats.count,
                    Math.round(stats.totalScore / stats.count),
                    Math.round((stats.count / results.length) * 100) + '%'
                ])
            ];
            
            const ws3 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws3, "Statistiques");
            
            // T√©l√©charger le fichier
            const fileName = `Quiz_Anglais_${new Date().toISOString().slice(0,10)}_${results.length}participants.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Notification
            showNotification('üìä Fichier Excel g√©n√©r√© et t√©l√©charg√© !', 'success');
        }
        
        function showNotification(message, type) {
            // Cr√©er une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                transition: opacity 0.3s;
                ${type === 'success' ? 'background: #28a745;' : 'background: #ffc107; color: #856404;'}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Supprimer apr√®s 5 secondes
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 5000);
        }
        
        function determineLevel(score) {
            // Logique de calcul du niveau bas√©e sur le score
            if (score <= 3) return "A0";
            if (score <= 8) return "A1";
            if (score <= 15) return "A2";
            if (score <= 23) return "B1";
            if (score <= 32) return "B2";
            if (score <= 40) return "C1";
            return "C2";
        }
        
        function showResults(level) {
            // Masquer le quiz et afficher les r√©sultats
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('navigation').style.display = 'none';
            document.getElementById('results').classList.add('show');
            
            // Afficher le niveau et la description
            const levelInfo = levelDescriptions[level];
            document.getElementById('finalLevel').textContent = `Niveau ${level}`;
            document.getElementById('levelTitle').textContent = levelInfo.title;
            document.getElementById('levelDescription').innerHTML = `
                <h4>Votre niveau en d√©tail :</h4>
                <p>${levelInfo.description}</p>
                <br>
                <p><strong>Exemple d'expression :</strong> <em>"${levelInfo.example}"</em></p>
                <br>
                <p><strong>Votre score :</strong> ${totalScore} points sur ${questions.reduce((sum, q) => sum + q.points, 0)} possibles</p>
            `;
            
            // Faire d√©filer vers le haut
            window.scrollTo(0, 0);
        }
        
        function saveResults(results) {
            // Sauvegarder dans localStorage
            const existingResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
            existingResults.push(results);
            localStorage.setItem('quizResults', JSON.stringify(existingResults));
            
            // Ici, vous pourrez plus tard ajouter l'envoi vers votre serveur
            console.log('R√©sultats sauvegard√©s:', results);
        }
        
        function restartQuiz() {
            // R√©initialiser toutes les variables
            currentQuestion = 0;
            userAnswers = [];
            totalScore = 0;
            quizStarted = false;
            userData = {};
            
            // R√©initialiser l'interface
            document.getElementById('results').classList.remove('show');
            document.getElementById('welcome').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('navigation').style.display = 'none';
            
            // Vider les champs
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            
            // Faire d√©filer vers le haut
            window.scrollTo(0, 0);
        }
        
        // Fonction pour r√©cup√©rer tous les r√©sultats (pour l'administrateur)
        function getAllResults() {
            return JSON.parse(localStorage.getItem('quizResults') || '[]');
        }
        
        // Fonction pour tester l'envoi d'email
        function testEmailConnection() {
            if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'VOTRE_EMAILJS_PUBLIC_KEY') {
                alert('‚ùå EmailJS non configur√© !');
                return;
            }
            
            const testParams = {
                to_email: ADMIN_EMAIL,
                subject: 'Test EmailJS - Quiz Anglais',
                message: `Test de connexion EmailJS effectu√© le ${new Date().toLocaleString('fr-FR')}.\n\nSi vous recevez cet email, la configuration fonctionne !`,
                attachment_name: '',
                attachment_data: ''
            };
            
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, testParams)
                .then(function(response) {
                    alert('‚úÖ Test envoy√© ! V√©rifiez votre bo√Æte email.');
                    showNotification('üìß Test envoy√© par email', 'success');
                }, function(error) {
                    alert('‚ùå Erreur lors du test : ' + JSON.stringify(error));
                    console.error('Erreur test:', error);
                });
        }
        
        // Fonction pour g√©n√©rer Excel √† tout moment (bouton admin)
        function exportAllToExcel() {
            const results = getAllResults();
            if (results.length === 0) {
                alert('‚ùå Aucun r√©sultat √† exporter.');
                return;
            }
            
            const excelBlob = generateExcelBlob(results);
            const link = document.createElement('a');
            const url = URL.createObjectURL(excelBlob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Quiz_Anglais_${new Date().toISOString().slice(0,10)}_${results.length}participants.xlsx`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üìä Excel t√©l√©charg√© !', 'success');
        }
        
        // Fonction pour exporter en CSV simple (backup)
        function exportResults() {
            const results = getAllResults();
            if (results.length === 0) {
                alert('Aucun r√©sultat √† exporter.');
                return;
            }
            
            const headers = ['Date', 'Pr√©nom', 'Nom', 'Email', 'T√©l√©phone', 'Niveau', 'Score', 'Dur√©e'];
            const csvContent = [
                headers.join(','),
                ...results.map(result => {
                    const duration = result.duration || 'N/A';
                    return [
                        new Date(result.completionTime).toLocaleDateString('fr-FR'),
                        result.firstName,
                        result.lastName,
                        result.email,
                        result.phone || '',
                        result.level,
                        result.score,
                        duration + (typeof duration === 'number' ? ' min' : '')
                    ].map(field => `"${field}"`).join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'resultats_quiz_' + new Date().toISOString().slice(0,10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Fonction pour vider toutes les donn√©es (reset)
        function clearAllResults() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUS les r√©sultats ? Cette action est irr√©versible.')) {
                localStorage.removeItem('quizResults');
                showNotification('üóëÔ∏è Tous les r√©sultats ont √©t√© supprim√©s.', 'warning');
            }
        }
        
        // Fonction simple pour activer le panneau admin
        function toggleAdminPanel() {
            const password = prompt('üîê Code administrateur :');
            if (password === 'admin123') {
                document.getElementById('adminPanel').style.display = 'block';
                updateEmailStatus();
                showNotification('üë®‚Äçüíº Mode administrateur activ√© !', 'success');
            } else if (password !== null) {
                showNotification('‚ùå Code incorrect !', 'warning');
            }
        }
        
        // Fonction pour masquer le panneau admin
        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            showNotification('üë®‚Äçüíº Panneau admin masqu√©', 'success');
        }
        
        // Fonction pour v√©rifier le statut Email
        function updateEmailStatus() {
            const statusElement = document.getElementById('emailStatus');
            const emailElement = document.getElementById('adminEmailDisplay');
            const countElement = document.getElementById('resultsCount');
            
            if (statusElement) {
                if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'VOTRE_EMAILJS_PUBLIC_KEY') {
                    statusElement.innerHTML = '‚úÖ Configur√©';
                    statusElement.style.color = '#28a745';
                } else {
                    statusElement.innerHTML = '‚ùå Non configur√©';
                    statusElement.style.color = '#dc3545';
                }
            }
            
            if (emailElement) {
                emailElement.textContent = ADMIN_EMAIL !== 'votre-email@exemple.com' ? ADMIN_EMAIL : 'Non configur√©';
            }
            
            if (countElement) {
                countElement.textContent = getAllResults().length;
            }
        }
        
        // Fonction pour activer le mode admin (triple-clic sur le titre)
        function activateAdminMode() {
            adminClicks++;
            clearTimeout(adminTimeout);
            
            if (adminClicks === 3) {
                const password = prompt('üîê Code administrateur :');
                if (password === 'admin123') { // Changez ce mot de passe !
                    document.getElementById('adminPanel').style.display = 'block';
                    updateEmailStatus(); // Mettre √† jour le statut
                    showNotification('üë®‚Äçüíº Mode administrateur activ√© !', 'success');
                } else if (password !== null) {
                    showNotification('‚ùå Code incorrect !', 'warning');
                }
                adminClicks = 0;
            } else {
                adminTimeout = setTimeout(() => {
                    adminClicks = 0;
                }, 1000);
            }
        }
        
        // Ajouter l'√©v√©nement de clic simple au bouton (plus besoin de triple-clic)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Quiz charg√© - Bouton admin disponible');
        });
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey) {
                switch(e.key) {
                    case 'E': // Ctrl+Shift+E = Export Excel
                        e.preventDefault();
                        exportAllToExcel();
                        break;
                    case 'C': // Ctrl+Shift+C = Export CSV
                        e.preventDefault();
                        exportResults();
                        break;
                    case 'R': // Ctrl+Shift+R = Voir tous les r√©sultats
                        e.preventDefault();
                        console.table(getAllResults());
                        alert(`üìä ${getAllResults().length} r√©sultats dans la console (F12)`);
                        break;
                    case 'X': // Ctrl+Shift+X = Clear all
                        e.preventDefault();
                        clearAllResults();
                        break;
                }
            }
        });
    </script>
</body>
</html>
