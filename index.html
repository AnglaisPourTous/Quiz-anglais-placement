<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Placement - Cours d'Anglais</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-blue: #2563eb;
            --primary-orange: #f97316;
            --secondary-blue: #3b82f6;
            --secondary-orange: #fb923c;
            --light-blue: #dbeafe;
            --light-orange: #fed7aa;
            --dark-blue: #1e40af;
            --dark-orange: #ea580c;
            --gradient-blue: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --gradient-orange: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            --gradient-mixed: linear-gradient(135deg, #2563eb 0%, #f97316 100%);
            --shadow-blue: 0 20px 40px rgba(37, 99, 235, 0.2);
            --shadow-orange: 0 20px 40px rgba(249, 115, 22, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(37, 99, 235, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(249, 115, 22, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.2) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes float {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-mixed);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.5; transform: scaleX(0.5); }
            50% { opacity: 1; transform: scaleX(1); }
        }
        
        .header {
            background: var(--gradient-mixed);
            color: white;
            padding: 60px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
            animation: slide 20s linear infinite;
        }
        
        @keyframes slide {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 800;
            position: relative;
            text-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(255,255,255,0.2), 0 4px 20px rgba(0,0,0,0.2); }
            to { text-shadow: 0 0 20px rgba(255,255,255,0.4), 0 4px 20px rgba(0,0,0,0.2); }
        }
        
        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            position: relative;
            font-weight: 300;
        }
        
        .quiz-content {
            padding: 50px 40px;
            background: rgba(255, 255, 255, 0.98);
        }
        
        .welcome-screen {
            text-align: center;
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .welcome-screen h2 {
            color: var(--dark-blue);
            margin-bottom: 25px;
            font-size: 2.5em;
            font-weight: 700;
            background: var(--gradient-mixed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-screen p {
            color: #64748b;
            font-size: 1.15em;
            line-height: 1.8;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .form-group {
            margin-bottom: 30px;
            text-align: left;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid transparent;
            border-radius: 15px;
            font-size: 16px;
            background: #f1f5f9;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }
        
        .form-group input:hover {
            background: #e2e8f0;
        }
        
        /* Styles pour le t√©l√©phone avec pays */
        .phone-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .country-select {
            width: auto;
            min-width: 140px;
            padding: 16px 15px;
            border: 2px solid transparent;
            border-radius: 15px;
            font-size: 16px;
            background: #f1f5f9;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }
        
        .country-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }
        
        .country-select:hover {
            background: #e2e8f0;
        }
        
        .phone-input {
            flex: 1;
        }
        
        .question-container {
            display: none;
            animation: slideIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .question-container.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(50px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }
        
        .question {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 40px;
            border-radius: 25px;
            margin-bottom: 35px;
            border-left: 5px solid var(--primary-orange);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .question::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.05) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .question h3 {
            color: var(--dark-blue);
            margin-bottom: 30px;
            font-size: 1.5em;
            font-weight: 600;
            line-height: 1.4;
            position: relative;
        }
        
        .options {
            display: grid;
            gap: 18px;
        }
        
        .option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 18px;
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }
        
        .option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--gradient-orange);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            z-index: 0;
        }
        
        .option:hover {
            border-color: var(--primary-orange);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.15);
        }
        
        .option:hover::before {
            width: 400px;
            height: 400px;
            opacity: 0.1;
        }
        
        .option.selected {
            border-color: var(--primary-orange);
            background: var(--gradient-orange);
            color: white;
            transform: scale(1.02);
            box-shadow: var(--shadow-orange);
        }
        
        .option.selected::before {
            display: none;
        }
        
        .option label {
            position: relative;
            z-index: 1;
            cursor: pointer;
            display: block;
        }
        
        .option input[type="radio"] {
            display: none;
        }
        
        .btn {
            background: var(--gradient-blue);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 30px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.3);
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            margin-bottom: 40px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-mixed);
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .results {
            display: none;
            text-align: center;
            animation: zoomIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes zoomIn {
            from { 
                opacity: 0; 
                transform: scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        .results.show {
            display: block;
        }
        
        .level-result {
            background: var(--gradient-mixed);
            color: white;
            padding: 50px;
            border-radius: 30px;
            margin: 40px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        .level-result::before {
            content: 'üéì';
            position: absolute;
            font-size: 150px;
            opacity: 0.1;
            right: -20px;
            top: -20px;
            animation: float 4s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .level-result h2 {
            font-size: 3.5em;
            margin-bottom: 15px;
            font-weight: 800;
            text-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .level-description {
            background: white;
            padding: 35px;
            border-radius: 20px;
            margin: 25px 0;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .level-description h4 {
            color: var(--primary-blue);
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 700;
        }
        
        .level-description p {
            line-height: 1.8;
            color: #475569;
            margin-bottom: 15px;
        }
        
        .level-description strong {
            color: var(--dark-blue);
            font-weight: 600;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 20px;
        }
        
        .question-counter {
            color: var(--dark-blue);
            font-weight: 700;
            font-size: 1.1em;
            padding: 10px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .contact-info {
            background: linear-gradient(135deg, var(--light-orange) 0%, var(--light-blue) 100%);
            border: 2px solid var(--primary-orange);
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .contact-info::before {
            content: 'üìû';
            position: absolute;
            font-size: 80px;
            opacity: 0.1;
            right: 20px;
            bottom: -20px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .contact-info h4 {
            color: var(--dark-orange);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 700;
        }
        
        .contact-info p {
            color: #7c2d12;
            line-height: 1.6;
        }
        
        /* Admin Panel Modernized */
        #adminPanel {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        #adminPanel h4 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 700;
        }
        
        #adminPanel .btn {
            font-size: 14px;
            padding: 12px 24px;
            margin: 5px;
            text-transform: none;
        }
        
        #adminPanel button[onclick="testEmailConnection()"] {
            background: var(--gradient-orange) !important;
        }
        
        #adminPanel button[onclick="sendExcelByEmail()"] {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
        }
        
        #adminPanel button[onclick="exportAllToExcel()"] {
            background: var(--gradient-blue) !important;
        }
        
        #adminPanel button[onclick="clearAllResults()"] {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        }
        
        #adminPanel button[onclick="restartQuiz()"] {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
        }
        
        #adminPanel p {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 20px;
            }
            
            .header {
                padding: 40px 25px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .quiz-content {
                padding: 35px 25px;
            }
            
            .navigation {
                flex-direction: column;
                gap: 20px;
                padding: 25px 20px;
            }
            
            .question {
                padding: 30px 25px;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .phone-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .country-select {
                width: 100%;
            }
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gradient-mixed);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-blue);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Quiz de Placement</h1>
            <p>√âvaluez votre niveau d'anglais en quelques minutes</p>
        </div>
        
        <div class="quiz-content">
            <!-- √âcran d'accueil -->
            <div id="welcome" class="welcome-screen">
                <h2>Bienvenue !</h2>
                <p>Ce quiz vous permettra de d√©terminer votre niveau d'anglais selon le Cadre Europ√©en Commun de R√©f√©rence (CECR). Il ne vous prendra que 10-15 minutes.</p>
                
                <div class="form-group">
                    <label for="firstName">Pr√©nom *</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Nom *</label>
                    <input type="text" id="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">T√©l√©phone</label>
                    <div class="phone-container">
                        <select id="countryCode" class="country-select">
                            <option value="+33">üá´üá∑ +33 France</option>
                            <option value="+32">üáßüá™ +32 Belgique</option>
                            <option value="+41">üá®üá≠ +41 Suisse</option>
                            <option value="+1">üá∫üá∏ +1 √âtats-Unis</option>
                            <option value="+1">üá®üá¶ +1 Canada</option>
                            <option value="+44">üá¨üáß +44 Royaume-Uni</option>
                            <option value="+49">üá©üá™ +49 Allemagne</option>
                            <option value="+39">üáÆüáπ +39 Italie</option>
                            <option value="+34">üá™üá∏ +34 Espagne</option>
                            <option value="+31">üá≥üá± +31 Pays-Bas</option>
                            <option value="+351">üáµüáπ +351 Portugal</option>
                            <option value="+212">üá≤üá¶ +212 Maroc</option>
                            <option value="+213">üá©üáø +213 Alg√©rie</option>
                            <option value="+216">üáπüá≥ +216 Tunisie</option>
                            <option value="+225">üá®üáÆ +225 C√¥te d'Ivoire</option>
                            <option value="+221">üá∏üá≥ +221 S√©n√©gal</option>
                            <option value="+237">üá®üá≤ +237 Cameroun</option>
                            <option value="+230">üá≤üá∫ +230 Maurice</option>
                            <option value="+33">üá¨üáµ +33 Guadeloupe</option>
                            <option value="+33">üá≤üá∂ +33 Martinique</option>
                            <option value="+262">üá∑üá™ +262 R√©union</option>
                            <option value="+590">üá¨üáµ +590 Saint-Martin</option>
                        </select>
                        <input type="tel" id="phone" class="phone-input" placeholder="123 456 789">
                    </div>
                </div>
                
                <button class="btn" onclick="startQuiz()">Commencer le Quiz</button>
                
                <!-- Bouton admin discret sur la page d'accueil -->
                <button onclick="toggleAdminPanel()" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; margin-top: 20px; cursor: pointer; opacity: 0.7; transition: all 0.3s;">‚öôÔ∏è Admin</button>
            </div>
            
            <!-- Barre de progression -->
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <!-- Questions du quiz -->
            <div id="quizContainer" style="display: none;">
                <!-- Les questions seront g√©n√©r√©es dynamiquement -->
            </div>
            
            <!-- Navigation -->
            <div id="navigation" style="display: none;" class="navigation">
                <button class="btn" id="prevBtn" onclick="previousQuestion()">‚Üê Pr√©c√©dent</button>
                <span class="question-counter" id="questionCounter"></span>
                <button class="btn" id="nextBtn" onclick="nextQuestion()">Suivant ‚Üí</button>
            </div>
            
            <!-- R√©sultats -->
            <div id="results" class="results">
                <div class="level-result" id="levelResult">
                    <h2 id="finalLevel"></h2>
                    <p id="levelTitle"></p>
                </div>
                
                <div class="level-description" id="levelDescription"></div>
                
                <div class="contact-info">
                    <h4>üéØ Prochaine √©tape</h4>
                    <p>Nos conseillers p√©dagogiques vont vous contacter sous 24h pour vous proposer un parcours personnalis√© adapt√© √† votre niveau.</p>
                </div>
            </div>
            
            <!-- Panneau admin accessible depuis n'importe o√π -->
            <div id="adminPanel" style="display: none; margin-top: 20px; padding: 20px;">
                <h4>üë®‚Äçüíº Panneau Administrateur</h4>
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <strong>üìä R√©sultats stock√©s :</strong> <span id="resultsCount">0</span> participant(s)
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="testEmailConnection()" style="background: var(--gradient-orange); margin: 5px; font-size: 16px; padding: 12px 20px;">
                        üîó Tester Email
                    </button>
                    <button class="btn" onclick="sendExcelByEmail()" style="margin: 5px;">üìß Envoyer Excel</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="exportAllToExcel()" style="margin: 5px;">üíæ T√©l√©charger Excel</button>
                    <button class="btn" onclick="exportResults()" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); margin: 5px;">üìÑ T√©l√©charger CSV</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="console.table(getAllResults())" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); margin: 5px;">üëÅÔ∏è Voir R√©sultats</button>
                    <button class="btn" onclick="clearAllResults()" style="margin: 5px;">üóëÔ∏è Effacer Tout</button>
                    <button class="btn" onclick="restartQuiz()" style="margin: 5px;">üîÑ Nouveau Quiz</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button class="btn" onclick="hideAdminPanel()" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); margin: 5px;">üëÅÔ∏è‚Äçüó®Ô∏è Masquer Panneau</button>
                </div>
                <p style="font-size: 0.9em; margin-top: 10px;">
                    <strong>Status Email :</strong> 
                    <span id="emailStatus" style="color: #ef4444;">‚ùå Non configur√©</span>
                </p>
                <p style="font-size: 0.9em; margin: 5px 0;">
                    <strong>Email de r√©ception :</strong> <code id="adminEmailDisplay" style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Non configur√©</code>
                </p>
                <p style="font-size: 0.9em; margin: 5px 0;">
                    <strong>Raccourcis :</strong> Ctrl+Shift+S (Envoyer Excel), Ctrl+Shift+E (Export), Ctrl+Shift+T (Test)
                </p>
            </div>
        </div>
    </div>

    <!-- SheetJS pour la g√©n√©ration Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- EmailJS pour l'envoi d'emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        // Configuration EmailJS pour envoi Excel
        const EMAILJS_PUBLIC_KEY = 'Rq-ONxcvbJxVEO29A'; // √Ä configurer
        const EMAILJS_SERVICE_ID = 'service_4vpwygs'; // √Ä configurer
        const EMAILJS_TEMPLATE_ID = 'template_0va9rfs'; // √Ä configurer
        const ADMIN_EMAIL = 'contact.veebly@gmail.com'; // Votre email
        
        // Initialiser EmailJS
        if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'VOTRE_EMAILJS_PUBLIC_KEY') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }
        
        // Questions du quiz organis√©es par niveau CECR - Difficult√© augment√©e
        const questions = [
            // A1 (Questions niveau A2 pour tester A1)
            {
                level: "A1",
                question: "Where __ you yesterday at 3 PM?",
                options: ["was", "were", "are", "did"],
                correct: 1,
                points: 1
            },
            {
                level: "A1",
                question: "I can't find my keys. Have you seen __?",
                options: ["it", "them", "they", "their"],
                correct: 1,
                points: 1
            },
            {
                level: "A1",
                question: "She __ to the gym twice a week.",
                options: ["go", "goes", "going", "is go"],
                correct: 1,
                points: 1
            },
            {
                level: "A1",
                question: "Choose the correct negative form: 'He speaks English.'",
                options: ["He don't speak English", "He doesn't speak English", "He not speak English", "He doesn't speaks English"],
                correct: 1,
                points: 1
            },
            
            // A2 (Questions niveau B1 pour tester A2)
            {
                level: "A2",
                question: "I've lived in Paris __ 2018.",
                options: ["for", "since", "from", "during"],
                correct: 1,
                points: 2
            },
            {
                level: "A2",
                question: "If it __ tomorrow, we'll cancel the picnic.",
                options: ["rain", "rains", "will rain", "raining"],
                correct: 1,
                points: 2
            },
            {
                level: "A2",
                question: "This book is __ than the one I read last week.",
                options: ["more interesting", "most interesting", "more interested", "the most interesting"],
                correct: 0,
                points: 2
            },
            {
                level: "A2",
                question: "He asked me where __.",
                options: ["do I live", "I live", "I lived", "did I live"],
                correct: 2,
                points: 2
            },
            
            // B1 (Questions niveau B2 pour tester B1)
            {
                level: "B1",
                question: "By next month, I __ here for exactly three years.",
                options: ["will work", "will have been working", "am working", "have worked"],
                correct: 1,
                points: 3
            },
            {
                level: "B1",
                question: "I wish I __ more time to finish this project.",
                options: ["have", "had", "would have", "having"],
                correct: 1,
                points: 3
            },
            {
                level: "B1",
                question: "The manager insisted that everyone __ the meeting.",
                options: ["attends", "attend", "attended", "to attend"],
                correct: 1,
                points: 3
            },
            {
                level: "B1",
                question: "__ having a cold, she went to work.",
                options: ["Although", "Despite", "However", "Even"],
                correct: 1,
                points: 3
            },
            
            // B2 (Questions niveau C1 pour tester B2)
            {
                level: "B2",
                question: "Little __ that his invention would change the world.",
                options: ["he knew", "did he know", "he did know", "knew he"],
                correct: 1,
                points: 4
            },
            {
                level: "B2",
                question: "The report needs __ before the deadline.",
                options: ["to submit", "submitting", "to be submitted", "being submitted"],
                correct: 2,
                points: 4
            },
            {
                level: "B2",
                question: "Not until the sun set __ the temperature drop.",
                options: ["did", "had", "was", "has"],
                correct: 0,
                points: 4
            },
            {
                level: "B2",
                question: "The committee is divided __ the issue of budget allocation.",
                options: ["over", "about", "on", "for"],
                correct: 0,
                points: 4
            },
            
            // C1 (Questions niveau C2 pour tester C1)
            {
                level: "C1",
                question: "The evidence was __, leaving no doubt about the verdict.",
                options: ["irrefutable", "irresponsible", "irreversible", "irregular"],
                correct: 0,
                points: 5
            },
            {
                level: "C1",
                question: "__ the CEO's objections, the board approved the merger.",
                options: ["Nevertheless", "Notwithstanding", "Whereas", "Albeit"],
                correct: 1,
                points: 5
            },
            {
                level: "C1",
                question: "The senator's speech was full of __ remarks about his opponents.",
                options: ["derogatory", "derivative", "deliberate", "delectable"],
                correct: 0,
                points: 5
            },
            {
                level: "C1",
                question: "Were it not __ the support of my colleagues, I wouldn't have succeeded.",
                options: ["to", "for", "with", "by"],
                correct: 1,
                points: 5
            },
            
            // C2 (Questions tr√®s difficiles pour tester C2)
            {
                level: "C2",
                question: "The author's __ style made the text almost impenetrable.",
                options: ["perspicuous", "perspicacious", "perfidious", "prolix"],
                correct: 3,
                points: 6
            },
            {
                level: "C2",
                question: "So __ was her argument that even her detractors were swayed.",
                options: ["cogent", "complacent", "corpulent", "clandestine"],
                correct: 0,
                points: 6
            },
            {
                level: "C2",
                question: "__ it not for the timely intervention of the whistleblower, the malfeasance __ undetected indefinitely.",
                options: ["Had / might have gone", "Were / would have gone", "Should / could have gone", "Would / should have gone"],
                correct: 1,
                points: 6
            },
            {
                level: "C2",
                question: "The new policy is __ to our previous approach.",
                options: ["antithetical", "apocryphal", "anachronistic", "anodyne"],
                correct: 0,
                points: 6
            }
        ];
        
        let currentQuestion = 0;
        let userAnswers = [];
        let totalScore = 0;
        let quizStarted = false;
        let userData = {};
        
        // Descriptions des niveaux CECR
        // Descriptions des niveaux CECR mises √† jour avec sous-niveaux
        const levelDescriptions = {
            "A0": {
                title: "Beginner - D√©butant absolu",
                description: "Vous commencez √† apprendre vos premiers mots en anglais. Vous pouvez comprendre et utiliser des expressions tr√®s famili√®res et quotidiennes.",
                example: "Coffee? (Caf√© ?)"
            },
            "A1": {
                title: "Elementary - √âl√©mentaire", 
                description: "Vous pouvez comprendre et utiliser des expressions famili√®res et quotidiennes ainsi que des √©nonc√©s tr√®s simples qui visent √† satisfaire des besoins concrets.",
                example: "Want coffee with me? (Tu veux un caf√© avec moi ?)"
            },
            "A2.1": {
                title: "Pre-intermediate - Communication de base",
                description: "Vous pouvez communiquer lors de t√¢ches simples et habituelles. Vous ma√Ætrisez les temps de base (pr√©sent, pass√© simple) et pouvez parler de vos exp√©riences.",
                example: "I went to the cinema yesterday. (Je suis all√© au cin√©ma hier.)"
            },
            "A2.2": {
                title: "Pre-intermediate - Pass√© et futur",
                description: "Vous pouvez exprimer le futur et parler de projets. Vous commencez √† utiliser le present perfect et pouvez d√©crire des exp√©riences pass√©es.",
                example: "I'm going to visit my friend next week. (Je vais rendre visite √† mon ami la semaine prochaine.)"
            },
            "A2.3": {
                title: "Pre-intermediate - Structures complexes",
                description: "Vous ma√Ætrisez les comparatifs et pouvez utiliser des phrases conditionnelles simples. Vous pouvez exprimer vos opinions de mani√®re simple.",
                example: "If it rains, we will stay home. (S'il pleut, nous resterons √† la maison.)"
            },
            "B1.1": {
                title: "Intermediate - Travail et √©tudes",
                description: "Vous pouvez comprendre les points essentiels dans un contexte professionnel ou scolaire. Vous ma√Ætrisez les temps complexes comme le futur ant√©rieur.",
                example: "By the time you arrive, I will have finished. (Quand tu arriveras, j'aurai termin√©.)"
            },
            "B1.2": {
                title: "Intermediate - Situations sociales",
                description: "Vous pouvez interagir avec une certaine aisance dans des situations sociales vari√©es. Vous utilisez le conditionnel et exprimez des regrets.",
                example: "I wish I had more time to travel. (J'aimerais avoir plus de temps pour voyager.)"
            },
            "B1.3": {
                title: "Intermediate - Grammaire complexe",
                description: "Vous ma√Ætrisez les g√©rondifs, les structures avec 'suggest' et les expressions de cause et cons√©quence.",
                example: "Despite studying hard, he failed. (Malgr√© ses √©tudes assidues, il a √©chou√©.)"
            },
            "B2.1": {
                title: "Upper-intermediate - Contextes professionnels",
                description: "Vous pouvez comprendre le contenu essentiel de sujets concrets ou abstraits dans un texte complexe, y compris une discussion technique dans votre sp√©cialit√©.",
                example: "The company's profits have increased significantly. (Les b√©n√©fices de l'entreprise ont consid√©rablement augment√©.)"
            },
            "B2.2": {
                title: "Upper-intermediate - Concepts abstraits",
                description: "Vous pouvez interagir avec un degr√© de spontan√©it√© et d'aisance tel qu'une conversation avec un locuteur natif ne comportant de tension ni pour l'un ni pour l'autre.",
                example: "She has a knack for languages. (Elle a un don pour les langues.)"
            },
            "B2.3": {
                title: "Upper-intermediate - Structures avanc√©es",
                description: "Vous pouvez produire un discours clair et d√©taill√© sur une grande gamme de sujets, exprimer un avis sur un sujet d'actualit√© et exposer les avantages et les inconv√©nients.",
                example: "Owing to the weather conditions, the flight was delayed. (En raison des conditions m√©t√©orologiques, le vol a √©t√© retard√©.)"
            },
            "C1.1": {
                title: "Advanced - Ma√Ætrise professionnelle",
                description: "Vous pouvez comprendre une grande gamme de textes longs et exigeants, ainsi que saisir des significations implicites. Vous utilisez un vocabulaire sophistiqu√©.",
                example: "The committee reached a unanimous decision. (Le comit√© a pris une d√©cision unanime.)"
            },
            "C2": {
                title: "Proficient - Ma√Ætrise compl√®te",
                description: "Vous pouvez comprendre sans effort pratiquement tout ce que vous lisez ou entendez et vous exprimer spontan√©ment, tr√®s couramment et de fa√ßon pr√©cise.",
                example: "The novel's intricate narrative structure... (La structure narrative complexe du roman...)"
            }
        };
        
        function startQuiz() {
            // Valider les champs obligatoires
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phoneNumber = document.getElementById('phone').value.trim();
            
            if (!firstName || !lastName || !email) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }
            
            // Valider l'email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Veuillez entrer une adresse email valide.');
                return;
            }
            
            // Valider que le t√©l√©phone contient au moins un chiffre
            if (!phoneNumber || !/\d/.test(phoneNumber)) {
                alert('Veuillez saisir au moins un num√©ro de t√©l√©phone.');
                return;
            }
            
            // R√©cup√©rer le t√©l√©phone avec code pays
            const countryCode = document.getElementById('countryCode').value;
            const fullPhone = `${countryCode} ${phoneNumber}`;
            
            // Sauvegarder les donn√©es utilisateur
            userData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: fullPhone,
                startTime: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
            
            // Masquer l'√©cran d'accueil et afficher le quiz
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('navigation').style.display = 'flex';
            
            quizStarted = true;
            showQuestion(0);
        }
        
        function showQuestion(index) {
            currentQuestion = index;
            
            // Mettre √† jour la barre de progression
            const progress = ((index) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Mettre √† jour le compteur
            document.getElementById('questionCounter').textContent = `Question ${index + 1} sur ${questions.length}`;
            
            // G√©n√©rer la question
            const question = questions[index];
            const quizContainer = document.getElementById('quizContainer');
            
            quizContainer.innerHTML = `
                <div class="question-container active">
                    <div class="question">
                        <h3>${question.question}</h3>
                        <div class="options">
                            ${question.options.map((option, i) => `
                                <div class="option" onclick="selectOption(${i})">
                                    <input type="radio" name="q${index}" value="${i}" id="q${index}_${i}">
                                    <label for="q${index}_${i}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Restaurer la r√©ponse pr√©c√©dente si elle existe
            if (userAnswers[index] !== undefined) {
                selectOption(userAnswers[index]);
            }
            
            // Mettre √† jour les boutons de navigation
            document.getElementById('prevBtn').style.display = index > 0 ? 'inline-block' : 'none';
            document.getElementById('nextBtn').textContent = index === questions.length - 1 ? 'Terminer' : 'Suivant ‚Üí';
        }
        
        function selectOption(optionIndex) {
            // D√©selectionner toutes les options
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));
            
            // S√©lectionner l'option cliqu√©e
            options[optionIndex].classList.add('selected');
            const radio = options[optionIndex].querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Sauvegarder la r√©ponse
            userAnswers[currentQuestion] = optionIndex;
        }
        
        function nextQuestion() {
            if (userAnswers[currentQuestion] === undefined) {
                alert('Veuillez s√©lectionner une r√©ponse avant de continuer.');
                return;
            }
            
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            } else {
                finishQuiz();
            }
        }
        
        function previousQuestion() {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }
        
        function finishQuiz() {
            // Calculer le score
            totalScore = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correct) {
                    totalScore += questions[i].points;
                }
            }
            
            // D√©terminer le niveau
            const level = determineLevel(totalScore);
            
            // Calculer la dur√©e
            const duration = Math.round((new Date().getTime() - new Date(userData.startTime).getTime()) / 60000);
            
            // Pr√©parer les d√©tails des r√©ponses pour Google Sheets
            const detailedAnswers = questions.map((q, i) => {
                const userAnswer = userAnswers[i];
                const isCorrect = userAnswer === q.correct;
                return {
                    question: q.question,
                    level: q.level,
                    userAnswer: q.options[userAnswer] || 'Non r√©pondu',
                    correctAnswer: q.options[q.correct],
                    isCorrect: isCorrect,
                    pointsEarned: isCorrect ? q.points : 0
                };
            });
            
            // Sauvegarder les r√©sultats
            const results = {
                ...userData,
                answers: userAnswers,
                detailedAnswers: detailedAnswers,
                score: totalScore,
                maxScore: questions.reduce((sum, q) => sum + q.points, 0),
                percentage: Math.round((totalScore / questions.reduce((sum, q) => sum + q.points, 0)) * 100),
                level: level,
                completionTime: new Date().toISOString(),
                questionsAnswered: questions.length,
                duration: duration
            };
            
            // Sauvegarder dans localStorage (backup local)
            saveResults(results);
            
            // Envoyer automatiquement par email √† l'administrateur
            sendResultsByEmail(results);
            
            // Afficher les r√©sultats
            showResults(level);
        }
        
        function sendResultsByEmail(results) {
            // V√©rifier la configuration EmailJS
            if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'VOTRE_EMAILJS_PUBLIC_KEY') {
                console.log('EmailJS non configur√©. Donn√©es sauvegard√©es localement seulement.');
                showNotification('üìä R√©sultats sauvegard√©s localement. Configuration email requise pour envoi automatique.', 'warning');
                return;
            }
            
            // Pr√©parer un r√©sum√© des r√©ponses pour l'email
            const answersText = results.detailedAnswers.map((answer, i) => 
                `Question ${i+1} (${answer.level}): ${answer.question}\n` +
                `R√©ponse donn√©e: ${answer.userAnswer}\n` +
                `R√©ponse correcte: ${answer.correctAnswer}\n` +
                `R√©sultat: ${answer.isCorrect ? 'Correct ‚úì' : 'Incorrect ‚úó'}\n` +
                `Points obtenus: ${answer.pointsEarned}/${questions[i].points}\n`
            ).join('\n' + '='.repeat(50) + '\n');
            
            // Pr√©parer l'email individuel pour ce participant
            const emailParams = {
                to_email: ADMIN_EMAIL,
                subject: `üéì Nouveau r√©sultat quiz: ${results.firstName} ${results.lastName} - Niveau ${results.level}`,
                participant_name: `${results.firstName} ${results.lastName}`,
                participant_email: results.email,
                participant_phone: results.phone || 'Non renseign√©',
                participant_level: results.level,
                participant_score: `${results.score}/${results.maxScore} points`,
                participant_percentage: `${results.percentage}%`,
                participant_duration: `${results.duration} minutes`,
                test_date: new Date().toLocaleDateString('fr-FR'),
                test_time: new Date().toLocaleTimeString('fr-FR'),
                detailed_answers: answersText,
                message: `
Nouveau participant au quiz de placement d'anglais :

üë§ INFORMATIONS PARTICIPANT
Nom complet : ${results.firstName} ${results.lastName}
Email : ${results.email}
T√©l√©phone : ${results.phone || 'Non renseign√©'}

üìä R√âSULTATS
Niveau CECR : ${results.level}
Score : ${results.score}/${results.maxScore} points (${results.percentage}%)
Dur√©e du test : ${results.duration} minutes
Date/Heure : ${new Date().toLocaleString('fr-FR')}

üìù D√âTAILS DES R√âPONSES
${answersText}

Cette √©valuation a √©t√© r√©alis√©e via le quiz en ligne automatique.
                `
            };
            
            // Envoyer l'email automatiquement
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailParams)
                .then(function(response) {
                    console.log('Email envoy√© automatiquement !', response);
                    showNotification('‚úÖ R√©sultats envoy√©s par email automatiquement !', 'success');
                }, function(error) {
                    console.error('Erreur envoi email automatique:', error);
                    showNotification('‚ö†Ô∏è Erreur envoi email. R√©sultats sauvegard√©s localement.', 'warning');
                });
        }
        
        function sendExcelByEmail() {
            const results = getAllResults();
            if (results.length === 0) {
                alert('‚ùå Aucun r√©sultat √† envoyer.');
                return;
            }
            
            // V√©rifier la configuration EmailJS
            if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'VOTRE_EMAILJS_PUBLIC_KEY') {
                alert('‚ùå EmailJS non configur√© !');
                return;
            }
            
            showNotification('üìä G√©n√©ration de l\'Excel en cours...', 'warning');
            
            // G√©n√©rer l'Excel
            const excelBlob = generateExcelBlob(results);
            
            // Convertir le blob en base64
            const reader = new FileReader();
            reader.onload = function() {
                const base64Data = reader.result.split(',')[1]; // Enlever le pr√©fixe data:...
                
                // Pr√©parer l'email avec l'Excel en pi√®ce jointe
                const emailParams = {
                    to_email: ADMIN_EMAIL,
                    subject: `üìä Export Excel Quiz Anglais - ${results.length} participants - ${new Date().toLocaleDateString('fr-FR')}`,
                    message: `
Voici l'export Excel consolid√© avec tous les r√©sultats du quiz de placement d'anglais.

üìä R√âSUM√â DE L'EXPORT :
- Nombre total de participants : ${results.length}
- P√©riode couverte : du ${new Date(results[0].completionTime).toLocaleDateString('fr-FR')} au ${new Date(results[results.length-1].completionTime).toLocaleDateString('fr-FR')}
- Date de g√©n√©ration : ${new Date().toLocaleString('fr-FR')}

üìà R√âPARTITION PAR NIVEAU :
${generateLevelSummary(results)}

Le fichier Excel contient 3 feuilles :
1. R√©sum√© de tous les participants
2. Statistiques par niveau  
3. D√©tails des r√©ponses (10 derniers)

Cordialement,
Syst√®me automatique Quiz Anglais
                    `,
                    attachment_name: `Quiz_Anglais_Export_${new Date().toISOString().slice(0,10)}_${results.length}participants.xlsx`,
                    attachment_data: base64Data
                };
                
                // Envoyer l'email
                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailParams)
                    .then(function(response) {
                        console.log('Excel envoy√© par email !', response);
                        showNotification('‚úÖ Excel envoy√© par email avec succ√®s !', 'success');
                        
                        // Optionnel : Vider les r√©sultats apr√®s envoi
                        if (confirm('üìß Excel envoy√© ! Voulez-vous effacer les r√©sultats locaux de ce navigateur admin ?')) {
                            clearAllResults();
                        }
                    }, function(error) {
                        console.error('Erreur envoi email:', error);
                        showNotification('‚ùå Erreur lors de l\'envoi email.', 'warning');
                        alert('Erreur : ' + JSON.stringify(error));
                    });
            };
            
            reader.readAsDataURL(excelBlob);
        }
        
        function generateExcelBlob(results) {
            // Cr√©er un classeur Excel
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: R√©sum√© des participants
            const summaryData = [
                ['Date', 'Heure', 'Pr√©nom', 'Nom', 'Email', 'T√©l√©phone', 'Niveau CECR', 'Score', 'Points Max', 'Pourcentage', 'Dur√©e (min)'],
                ...results.map(result => [
                    new Date(result.completionTime).toLocaleDateString('fr-FR'),
                    new Date(result.completionTime).toLocaleTimeString('fr-FR'),
                    result.firstName,
                    result.lastName,
                    result.email,
                    result.phone || '',
                    result.level,
                    result.score,
                    result.maxScore || questions.reduce((sum, q) => sum + q.points, 0),
                    result.percentage || Math.round((result.score / questions.reduce((sum, q) => sum + q.points, 0)) * 100) + '%',
                    result.duration || 'N/A'
                ])
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Ajuster la largeur des colonnes
            ws1['!cols'] = [
                {wch: 12}, {wch: 10}, {wch: 15}, {wch: 15}, {wch: 25}, 
                {wch: 15}, {wch: 10}, {wch: 8}, {wch: 10}, {wch: 12}, {wch: 10}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws1, "R√©sum√© Participants");
            
            // Feuille 2: Statistiques par niveau
            const levelStats = {};
            results.forEach(result => {
                if (!levelStats[result.level]) {
                    levelStats[result.level] = { count: 0, totalScore: 0, emails: [] };
                }
                levelStats[result.level].count++;
                levelStats[result.level].totalScore += result.score;
                levelStats[result.level].emails.push(result.email);
            });
            
            const statsData = [
                ['Niveau CECR', 'Nombre de Participants', 'Score Moyen', 'Pourcentage du Total'],
                ...Object.entries(levelStats).map(([level, stats]) => [
                    level,
                    stats.count,
                    Math.round(stats.totalScore / stats.count),
                    Math.round((stats.count / results.length) * 100) + '%'
                ])
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws2, "Statistiques");
            
            // Feuille 3: D√©tails des r√©ponses (optionnel, pour les 10 derniers)
            if (results.length > 0) {
                const lastResults = results.slice(-10); // 10 derniers
                const detailsData = [
                    ['Participant', 'Question', 'Niveau Q.', 'R√©ponse Donn√©e', 'R√©ponse Correcte', 'R√©sultat', 'Points']
                ];
                
                lastResults.forEach(result => {
                    if (result.detailedAnswers) {
                        result.detailedAnswers.forEach((answer, i) => {
                            detailsData.push([
                                `${result.firstName} ${result.lastName}`,
                                answer.question || `Question ${i+1}`,
                                answer.level || questions[i]?.level || '',
                                answer.userAnswer || 'Non r√©pondu',
                                answer.correctAnswer || questions[i]?.options[questions[i]?.correct] || '',
                                answer.isCorrect ? 'Correct' : 'Incorrect',
                                answer.pointsEarned || 0
                            ]);
                        });
                    }
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(detailsData);
                XLSX.utils.book_append_sheet(wb, ws3, "D√©tails R√©ponses");
            }
            
            // Convertir en blob
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            return new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        }
        
        function generateLevelSummary(results) {
            const levelStats = {};
            results.forEach(result => {
                levelStats[result.level] = (levelStats[result.level] || 0) + 1;
            });
            
            return Object.entries(levelStats)
                .map(([level, count]) => `- ${level}: ${count} participant${count > 1 ? 's' : ''}`)
                .join('\n');
        }
        
        function generateExcelReport() {
            const results = getAllResults();
            if (results.length === 0) return;
            
            // Cr√©er un classeur Excel
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: R√©sum√© des participants
            const summaryData = [
                ['Date', 'Pr√©nom', 'Nom', 'Email', 'T√©l√©phone', 'Niveau CECR', 'Score', 'Points Max', 'Pourcentage', 'Dur√©e (min)'],
                ...results.map(result => [
                    new Date(result.completionTime).toLocaleDateString('fr-FR'),
                    result.firstName,
                    result.lastName,
                    result.email,
                    result.phone || '',
                    result.level,
                    result.score,
                    questions.reduce((sum, q) => sum + q.points, 0),
                    Math.round((result.score / questions.reduce((sum, q) => sum + q.points, 0)) * 100) + '%',
                    result.duration || 'N/A'
                ])
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, "R√©sum√© Participants");
            
            // Feuille 2: D√©tails des r√©ponses (dernier participant)
            const lastResult = results[results.length - 1];
            const detailsData = [
                ['Question', 'Niveau', 'R√©ponse Donn√©e', 'R√©ponse Correcte', 'R√©sultat', 'Points'],
                ...questions.map((q, i) => [
                    q.question,
                    q.level,
                    q.options[lastResult.answers[i]] || 'Non r√©pondu',
                    q.options[q.correct],
                    lastResult.answers[i] === q.correct ? 'Correct' : 'Incorrect',
                    lastResult.answers[i] === q.correct ? q.points : 0
                ])
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(detailsData);
            XLSX.utils.book_append_sheet(wb, ws2, "D√©tails Dernier Quiz");
            
            // Feuille 3: Statistiques par niveau
            const levelStats = {};
            results.forEach(result => {
                if (!levelStats[result.level]) {
                    levelStats[result.level] = { count: 0, totalScore: 0 };
                }
                levelStats[result.level].count++;
                levelStats[result.level].totalScore += result.score;
            });
            
            const statsData = [
                ['Niveau CECR', 'Nombre de Participants', 'Score Moyen', 'Pourcentage'],
                ...Object.entries(levelStats).map(([level, stats]) => [
                    level,
                    stats.count,
                    Math.round(stats.totalScore / stats.count),
                    Math.round((stats.count / results.length) * 100) + '%'
                ])
            ];
            
            const ws3 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws3, "Statistiques");
            
            // T√©l√©charger le fichier
            const fileName = `Quiz_Anglais_${new Date().toISOString().slice(0,10)}_${results.length}participants.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Notification
            showNotification('üìä Fichier Excel g√©n√©r√© et t√©l√©charg√© !', 'success');
        }
        
        function showNotification(message, type) {
            // Cr√©er une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                transition: all 0.3s ease;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                ${type === 'success' ? 'background: var(--gradient-blue);' : 'background: var(--gradient-orange);'}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animation d'entr√©e
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
            }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 50);
            
            // Supprimer apr√®s 5 secondes
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 5000);
        }
        
        function determineLevel(score) {
            // Logique de calcul du niveau bas√©e sur le score (24 questions, max 84 points)
            // Seuils stricts pour que le r√©sultat soit environ un niveau en dessous du niveau r√©el
            if (score <= 3) return "A0";        // 0-3 points (moins de 75% du niveau A1)
            if (score <= 7) return "A1";        // 4-7 points (a r√©ussi niveau A1 mais pas A2)
            if (score <= 13) return "A2.1";     // 8-14 points
            if (score <= 20) return "A2.2";     // 15-21 points
            if (score <= 26) return "A2.3";     // 22-28 points
            if (score <= 34) return "B1.1";     // 29-38 points
            if (score <= 44) return "B1.2";     // 39-48 points
            if (score <= 55) return "B1.3";     // 49-58 points
            if (score <= 65) return "B2.1";     // 59-66 points
            if (score <= 72) return "B2.2";     // 67-74 points
            if (score <= 76) return "B2.3";     // 75-78 points
            if (score <= 80) return "C1.1";     // 79-82 points
            if (score <= 82) return "C1.2";     // 81-81 points
            return "C2";                        // 83-84 points (quasi-parfait requis pour C2)
        }
        
        function showResults(level) {
            // Masquer le quiz et afficher les r√©sultats
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('navigation').style.display = 'none';
            document.getElementById('results').classList.add('show');
            
            // Couleurs selon le niveau
            let levelColor = '#28a745'; // Vert par d√©faut
            if (level.startsWith('A')) levelColor = '#ffc107'; // Jaune pour A
            if (level.startsWith('B')) levelColor = '#17a2b8'; // Bleu pour B  
            if (level.startsWith('C')) levelColor = '#6f42c1'; // Violet pour C
            
            // Afficher le niveau et la description
            const levelInfo = levelDescriptions[level];
            const levelResult = document.getElementById('levelResult');
            levelResult.style.background = `linear-gradient(135deg, ${levelColor} 0%, ${levelColor}dd 100%)`;
            
            document.getElementById('finalLevel').textContent = `Niveau ${level}`;
            document.getElementById('levelTitle').textContent = levelInfo.title;
            document.getElementById('levelDescription').innerHTML = `
                <h4>Votre niveau en d√©tail :</h4>
                <p>${levelInfo.description}</p>
                <br>
                <p><strong>Exemple d'expression typique :</strong> <em>"${levelInfo.example}"</em></p>
                <br>
                <p><strong>Votre score :</strong> ${totalScore} points sur ${questions.reduce((sum, q) => sum + q.points, 0)} possibles (${Math.round((totalScore / questions.reduce((sum, q) => sum + q.points, 0)) * 100)}%)</p>
                <p><strong>Questions r√©pondues :</strong> ${questions.length}/${questions.length}</p>
            `;
            
            // Faire d√©filer vers le haut
            window.scrollTo(0, 0);
        }
        
        function saveResults(results) {
            // Sauvegarder dans localStorage
            const existingResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
            existingResults.push(results);
            localStorage.setItem('quizResults', JSON.stringify(existingResults));
            
            // Ici, vous pourrez plus tard ajouter l'envoi vers votre serveur
            console.log('R√©sultats sauvegard√©s:', results);
        }
        
        function restartQuiz() {
            // R√©initialiser toutes les variables
            currentQuestion = 0;
            userAnswers = [];
            totalScore = 0;
            quizStarted = false;
            userData = {};
            
            // R√©initialiser l'interface
            document.getElementById('results').classList.remove('show');
            document.getElementById('welcome').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('navigation').style.display = 'none';
            
            // Vider les champs
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('countryCode').value = '+33';
            
            // Faire d√©filer vers le haut
            window.scrollTo(0, 0);
        }
        
        // Fonction pour r√©cup√©rer tous les r√©sultats (pour l'administrateur)
        function getAllResults() {
            return JSON.parse(localStorage.getItem('quizResults') || '[]');
        }
        
        // Fonction pour tester l'envoi d'email
        function testEmailConnection() {
            if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'VOTRE_EMAILJS_PUBLIC_KEY') {
                alert('‚ùå EmailJS non configur√© !');
                return;
            }
            
            const testParams = {
                to_email: ADMIN_EMAIL,
                subject: 'Test EmailJS - Quiz Anglais',
                message: `Test de connexion EmailJS effectu√© le ${new Date().toLocaleString('fr-FR')}.\n\nSi vous recevez cet email, la configuration fonctionne !`,
                attachment_name: '',
                attachment_data: ''
            };
            
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, testParams)
                .then(function(response) {
                    alert('‚úÖ Test envoy√© ! V√©rifiez votre bo√Æte email.');
                    showNotification('üìß Test envoy√© par email', 'success');
                }, function(error) {
                    alert('‚ùå Erreur lors du test : ' + JSON.stringify(error));
                    console.error('Erreur test:', error);
                });
        }
        
        // Fonction pour g√©n√©rer Excel √† tout moment (bouton admin)
        function exportAllToExcel() {
            const results = getAllResults();
            if (results.length === 0) {
                alert('‚ùå Aucun r√©sultat √† exporter.');
                return;
            }
            
            const excelBlob = generateExcelBlob(results);
            const link = document.createElement('a');
            const url = URL.createObjectURL(excelBlob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Quiz_Anglais_${new Date().toISOString().slice(0,10)}_${results.length}participants.xlsx`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üìä Excel t√©l√©charg√© !', 'success');
        }
        
        // Fonction pour exporter en CSV simple (backup)
        function exportResults() {
            const results = getAllResults();
            if (results.length === 0) {
                alert('Aucun r√©sultat √† exporter.');
                return;
            }
            
            const headers = ['Date', 'Pr√©nom', 'Nom', 'Email', 'T√©l√©phone', 'Niveau', 'Score', 'Dur√©e'];
            const csvContent = [
                headers.join(','),
                ...results.map(result => {
                    const duration = result.duration || 'N/A';
                    return [
                        new Date(result.completionTime).toLocaleDateString('fr-FR'),
                        result.firstName,
                        result.lastName,
                        result.email,
                        result.phone || '',
                        result.level,
                        result.score,
                        duration + (typeof duration === 'number' ? ' min' : '')
                    ].map(field => `"${field}"`).join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'resultats_quiz_' + new Date().toISOString().slice(0,10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Fonction pour vider toutes les donn√©es (reset)
        function clearAllResults() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUS les r√©sultats ? Cette action est irr√©versible.')) {
                localStorage.removeItem('quizResults');
                showNotification('üóëÔ∏è Tous les r√©sultats ont √©t√© supprim√©s.', 'warning');
                updateEmailStatus();
            }
        }
        
        // Fonction simple pour activer le panneau admin
        function toggleAdminPanel() {
            const password = prompt('üîê Code administrateur :');
            if (password === 'admin123') {
                document.getElementById('adminPanel').style.display = 'block';
                updateEmailStatus();
                showNotification('üë®‚Äçüíº Mode administrateur activ√© !', 'success');
            } else if (password !== null) {
                showNotification('‚ùå Code incorrect !', 'warning');
            }
        }
        
        // Fonction pour masquer le panneau admin
        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            showNotification('üë®‚Äçüíº Panneau admin masqu√©', 'success');
        }
        
        // Fonction pour v√©rifier le statut Email
        function updateEmailStatus() {
            const statusElement = document.getElementById('emailStatus');
            const emailElement = document.getElementById('adminEmailDisplay');
            const countElement = document.getElementById('resultsCount');
            
            if (statusElement) {
                if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'VOTRE_EMAILJS_PUBLIC_KEY') {
                    statusElement.innerHTML = '‚úÖ Configur√©';
                    statusElement.style.color = '#10b981';
                } else {
                    statusElement.innerHTML = '‚ùå Non configur√©';
                    statusElement.style.color = '#ef4444';
                }
            }
            
            if (emailElement) {
                emailElement.textContent = ADMIN_EMAIL || 'Non configur√©';
            }
            
            if (countElement) {
                countElement.textContent = getAllResults().length;
            }
        }
        
        // Fonction pour activer le mode admin (triple-clic sur le titre)
        function activateAdminMode() {
            adminClicks++;
            clearTimeout(adminTimeout);
            
            if (adminClicks === 3) {
                const password = prompt('üîê Code administrateur :');
                if (password === 'admin123') { // Changez ce mot de passe !
                    document.getElementById('adminPanel').style.display = 'block';
                    updateEmailStatus(); // Mettre √† jour le statut
                    showNotification('üë®‚Äçüíº Mode administrateur activ√© !', 'success');
                } else if (password !== null) {
                    showNotification('‚ùå Code incorrect !', 'warning');
                }
                adminClicks = 0;
            } else {
                adminTimeout = setTimeout(() => {
                    adminClicks = 0;
                }, 1000);
            }
        }
        
        // Ajouter l'√©v√©nement de clic simple au bouton (plus besoin de triple-clic)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Quiz charg√© - Bouton admin disponible');
        });
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey) {
                switch(e.key) {
                    case 'S': // Ctrl+Shift+S = Envoyer Excel par email
                        e.preventDefault();
                        sendExcelByEmail();
                        break;
                    case 'E': // Ctrl+Shift+E = Export Excel
                        e.preventDefault();
                        exportAllToExcel();
                        break;
                    case 'T': // Ctrl+Shift+T = Test email
                        e.preventDefault();
                        testEmailConnection();
                        break;
                    case 'C': // Ctrl+Shift+C = Export CSV
                        e.preventDefault();
                        exportResults();
                        break;
                    case 'R': // Ctrl+Shift+R = Voir tous les r√©sultats
                        e.preventDefault();
                        console.table(getAllResults());
                        alert(`üìä ${getAllResults().length} r√©sultats dans la console (F12)`);
                        break;
                    case 'X': // Ctrl+Shift+X = Clear all
                        e.preventDefault();
                        clearAllResults();
                        break;
                }
            }
        });
    </script>
</body>
</html>
